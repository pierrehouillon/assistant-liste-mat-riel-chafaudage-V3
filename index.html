<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Configurateur échafaudage ALTRAD METRIX</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --primary: #c80000;
      --bg: #f5f5f5;
      --card: #ffffff;
      --border-radius: 12px;
      --text-main: #222;
      --text-muted: #666;
    }

    * { box-sizing: border-box; font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--text-main);
    }

    .app {
      max-width: 520px;
      margin: 0 auto;
      min-height: 100vh;
      padding: 16px;
    }

    h1 {
      text-align: center;
      font-size: 20px;
      margin-bottom: 16px;
      color: var(--primary);
    }

    .card {
      background: var(--card);
      border-radius: var(--border-radius);
      padding: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      margin-bottom: 16px;
    }

    label {
      display: block;
      font-size: 14px;
      margin-top: 10px;
      margin-bottom: 4px;
    }

    input, select {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 14px;
    }

    button {
      width: 100%;
      margin-top: 16px;
      padding: 12px;
      border-radius: 999px;
      border: none;
      background: var(--primary);
      color: white;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
    }

    button:disabled {
      opacity: 0.6;
      cursor: default;
    }

    .status {
      margin-top: 8px;
      font-size: 13px;
      color: var(--text-muted);
    }

    .status.error {
      color: #b71c1c;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      margin-top: 8px;
    }

    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid #eee;
      text-align: left;
    }

    th {
      background: #f0f0f0;
      font-weight: 600;
      font-size: 12px;
    }

    tfoot td {
      font-weight: 600;
      border-top: 2px solid #ccc;
    }

    .ref {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
    }

    .muted {
      color: var(--text-muted);
      font-size: 12px;
      margin-top: 4px;
    }
  </style>
</head>
<body>
<div class="app">
  <h1>Configurateur échafaudage</h1>

  <div class="card">
    <label>Longueur de façade L (m)</label>
    <input id="L" type="number" min="1" step="0.1" placeholder="ex : 5">

    <label>Hauteur H (m)</label>
    <input id="H" type="number" min="2" step="0.1" placeholder="ex : 6">

    <label>Largeur de l’échafaudage</label>
    <select id="largeur">
      <option value="1.00" selected>1,00 m</option>
      <option value="0.70">0,70 m</option>
    </select>

    <label>Protection côté mur ?</label>
    <select id="protection">
      <option value="OUI">OUI</option>
      <option value="NON">NON</option>
    </select>
    <div class="muted">
      ⚠ Obligatoire si l’espace entre l’échafaudage et le mur est supérieur à 20 cm.
    </div>

    <label>Grutage prévu ?</label>
    <select id="grutage">
      <option value="OUI">OUI</option>
      <option value="NON">NON</option>
    </select>

    <label>Stabilisation</label>
    <select id="stabilisation">
      <option value="stabilisateurs">Stabilisateurs télescopiques</option>
      <option value="amarrage">Amarrage au mur</option>
    </select>

    <button id="btn-calcul">Lancer le calcul</button>
    <div id="status" class="status"></div>
  </div>

  <div class="card" id="bloc-resultat" style="display:none;">
    <div style="font-weight:600; margin-bottom:4px;">
      Voici ta liste de matériel prête à être commandée.
    </div>
    <div class="muted" style="margin-bottom:4px;">
      Tu peux aller sur le back office ou ta tablette pour renseigner les références et les quantités.
    </div>
    <div id="recap" class="muted"></div>
    <div style="overflow-x:auto;">
      <table id="tableau">
        <thead>
          <tr>
            <th>Référence</th>
            <th>Désignation</th>
            <th>Qté</th>
            <th>Poids unitaire (kg)</th>
            <th>Poids total (kg)</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
        <tfoot>
          <tr>
            <td colspan="4">Poids total échafaudage</td>
            <td id="poids-global"></td>
          </tr>
          <tr>
            <td colspan="4">+ Estimation racks / paniers</td>
            <td id="poids-racks"></td>
          </tr>
          <tr>
            <td colspan="4">= Poids total global</td>
            <td id="poids-global-avec-racks"></td>
          </tr>
        </tfoot>
      </table>
    </div>
    <div id="transport-note" class="muted" style="margin-top:8px;"></div>
  </div>
</div>

<script>
// --- Données références (désignation + poids) ---
const REFERENCES = {
  "ALTASV5": { designation: "Socle à vérin 0,61 m", poids: 3.2 },
  "ALTAR12": { designation: "Roue orientable 250 kg avec vérin", poids: 9.5 },
  "ALTKEMB12": { designation: "Embase de départ", poids: 2.1 },
  "ALTKPT2": { designation: "Poteau standard hauteur 1,00 m", poids: 5.4 },
  "ALTKPT4": { designation: "Poteau standard hauteur 2,00 m", poids: 9.9 },
  "ALTKLC1": { designation: "Lisse 0,70 m", poids: 3.1 },
  "ALTKLC2": { designation: "Lisse 1,00 m", poids: 3.5 },
  "ALTKLC5": { designation: "Lisse 2,50 m", poids: 8.5 },
  "ALTKMC5": { designation: "Plancher acier 2,50 × 0,30 m", poids: 7.9 },
  "ALTKMC2": { designation: "Plancher acier 1,00 × 0,30 m", poids: 7.5 },
  "ALTKPE5": { designation: "Plancher trappe 2,50 × 0,60 m", poids: 25.4 },
  "ALTKDV5": { designation: "Diagonale verticale 2,50 × 2,00 m", poids: 13.0 },
  "ALTKGH5": { designation: "Garde-corps permanent de sécurité 2,50 m", poids: 13.2 },
  "ALTKGH1": { designation: "Garde-corps permanent 1,00 m (avec plinthe intégrée)", poids: 8.5 },
  "ALTKGH2": { designation: "Garde-corps permanent de fermeture 1,00 m", poids: 4.5 },
  "ALTKPI5": { designation: "Plinthe bois 2,50 m", poids: 5.0 },
  "ALT000675": { designation: "Stabilisateur télescopique 3,30–6,00 m", poids: 21.3 },
  "ALTAMX1": { designation: "Cale bois", poids: 1.6 },
  "ALTACPI": { designation: "Cale plastique", poids: 0.2 },
  "ALTAA11": { designation: "Tube d'amarrage 1,00 m crochet", poids: 3.9 },
  "ALTAPA2": { designation: "Ancrage diamètre 12 longueur 120 mm", poids: 0.2 },
  "ALTL99P": { designation: "Ancrage soudure", poids: 0.1 },
  "ALTRLEV": { designation: "Anneau de levage", poids: 0.1 },
  "ALTKB12": { designation: "Boulon jonction 12 × 60 mm", poids: 0.06 },
  "ALTKB13": { designation: "Boulon jonction 12 × 70 mm", poids: 0.07 },
  "ALTKFSV": { designation: "Fixe socle à vérin", poids: 0.1 }
};

const btn = document.getElementById("btn-calcul");
const statusEl = document.getElementById("status");
const blocResultat = document.getElementById("bloc-resultat");
const tbody = document.getElementById("tbody");
const recapEl = document.getElementById("recap");
const poidsGlobalEl = document.getElementById("poids-global");
const poidsRacksEl = document.getElementById("poids-racks");
const poidsGlobalAvecRacksEl = document.getElementById("poids-global-avec-racks");
const transportNoteEl = document.getElementById("transport-note");

btn.addEventListener("click", () => {
  const L = parseFloat(document.getElementById("L").value);
  const H = parseFloat(document.getElementById("H").value);
  const largeur = parseFloat(document.getElementById("largeur").value);
  const protection_mur = document.getElementById("protection").value;
  const grutage = document.getElementById("grutage").value;
  const stabilisation = document.getElementById("stabilisation").value;

  if (!L || !H) {
    statusEl.textContent = "Merci de remplir au moins la longueur et la hauteur.";
    statusEl.className = "status error";
    return;
  }

  statusEl.textContent = "Calcul en cours…";
  statusEl.className = "status";
  blocResultat.style.display = "none";

  const F = 1; // on considère toujours 1 façade
  const data = calculLocal(L, H, largeur, F, protection_mur, grutage, stabilisation);
  afficherResultats(data, { L, H, largeur, F, protection_mur, grutage, stabilisation });

  statusEl.textContent = "Calepinage terminé ✅";
  statusEl.className = "status";
});

// --- Calcul côté front, même logique que dans le Python ---
function calculLocal(L, H, largeur, F, protection_mur_str, grutage_str, stabilisation) {
  const protection_mur = protection_mur_str.toUpperCase() === "OUI";
  const grutage = grutage_str.toUpperCase() === "OUI";

  const T = Math.ceil(L / 2.5);  // travées
  const N = Math.ceil(H / 2.0);  // niveaux

  // 1) SOCLES / POTEAUX
  const ALTASV5 = 2 * T + 2;
  const ALTKEMB12 = ALTASV5;
  const ALTKPT2 = ALTASV5;
  const ALTKPT4 = ALTASV5 * N;

  // 2) LISSES
  const ALTKLC1 = Math.abs(largeur - 0.70) < 1e-6 ? 2 * T * N : 0;
  const ALTKLC2 = Math.abs(largeur - 1.00) < 1e-6 ? 2 * T * N : 0;
  const ALTKLC5 = protection_mur ? (2 * T + 2 * N) : (2 * T + N);

  // 3) PLANCHERS
  const base_planchers = 2 * T * N;
  const corr_largeur = Math.abs(largeur - 1.00) < 1e-6 ? N : 0;
  const corr_mur = protection_mur ? 2 : 0;
  const ALTKMC5 = base_planchers + corr_largeur - corr_mur;

  const nb_trappes = Math.max(1, Math.ceil(L / 20));
  const ALTKPE5 = F * N * nb_trappes;

  // 4) DIAGONALES
  const ALTKDV5 = protection_mur ? (2 * F) : (1 * F);

  // 5) GARDE-CORPS
  const ALTKGH5 = protection_mur ? (2 * T * N) : (T * N);
  const ALTKGH1 = Math.abs(largeur - 0.70) < 1e-6 ? 2 * N : 0;
  const ALTKGH2 = Math.abs(largeur - 1.00) < 1e-6 ? 2 * N : 0;

  // 6) PLINTHES
  const ALTKPI5 = 2 * T * N;

  // 7) STABILISATEURS
  const ALT000675 = (stabilisation === "stabilisateurs" && H <= 6) ? (T + 1) : 0;

  // 8) AMARRAGE
  const POINTS = (stabilisation === "amarrage") ? Math.ceil((L * H) / 12) : 0;
  const ALTAA11 = POINTS;
  const ALTAPA2 = POINTS;
  const ALTL99P = POINTS;

  // 9) GRUTAGE
  const ALTRLEV = grutage ? 4 : 0;
  const ALTKB12 = grutage ? ALTKPT4 : 0;
  const ALTKB13 = grutage ? ALTKEMB12 : 0;
  const ALTKFSV = grutage ? ALTASV5 : 0;

  const quantites = {
    ALTASV5,
    ALTKEMB12,
    ALTKPT2,
    ALTKPT4,
    ALTKLC1,
    ALTKLC2,
    ALTKLC5,
    ALTKMC5,
    ALTKPE5,
    ALTKDV5,
    ALTKGH5,
    ALTKGH1,
    ALTKGH2,
    ALTKPI5,
    ALT000675,
    ALTAA11,
    ALTAPA2,
    ALTL99P,
    ALTRLEV,
    ALTKB12,
    ALTKB13,
    ALTKFSV
  };

  const items = [];
  let poids_total_global = 0;

  for (const [ref, quantite] of Object.entries(quantites)) {
    if (quantite <= 0) continue;

    const meta = REFERENCES[ref] || {};
    const designation = meta.designation || "";
    const poids_unitaire = meta.poids ?? null;
    let poids_total = null;

    if (poids_unitaire != null) {
      poids_total = +(poids_unitaire * quantite).toFixed(1);
      poids_total_global += poids_total;
    }

    items.push({
      reference: ref,
      designation,
      quantite,
      poids_unitaire,
      poids_total
    });
  }

  poids_total_global = +poids_total_global.toFixed(1);

  return { items, poids_total_global };
}

// --- Affichage des résultats + racks + transport ---
function afficherResultats(data, params) {
  const items = data.items || [];
  const poidsGlobal = data.poids_total_global ?? null;

  tbody.innerHTML = "";

  if (items.length === 0) {
    tbody.innerHTML = "<tr><td colspan='5'>Aucun article calculé.</td></tr>";
  } else {
    for (const item of items) {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="ref">${item.reference}</td>
        <td>${item.designation || ""}</td>
        <td>${item.quantite}</td>
        <td>${item.poids_unitaire != null ? item.poids_unitaire.toFixed(1) : "-"}</td>
        <td>${item.poids_total != null ? item.poids_total.toFixed(1) : "-"}</td>
      `;
      tbody.appendChild(tr);
    }
  }

  // Poids échafaudage seul
  if (poidsGlobal != null) {
    poidsGlobalEl.textContent = poidsGlobal.toFixed(1) + " kg";
  } else {
    poidsGlobalEl.textContent = "-";
  }

  // Estimation racks / paniers (en nombre de références distinctes)
  const nbRefs = items.length;
  let poidsRacks = 0;

  if (nbRefs > 0 && nbRefs < 10) {
    poidsRacks = 43;                 // 1 châssis démontable seul
  } else if (nbRefs < 25) {
    poidsRacks = 173;                // 1 châssis (43) + 1 panier (130)
  } else if (nbRefs >= 25) {
    const blocs = Math.ceil(nbRefs / 25);
    poidsRacks = 173 * blocs;        // estimation simple par blocs de 25 réf.
  }

  poidsRacksEl.textContent = poidsRacks > 0 ? poidsRacks.toFixed(1) + " kg" : "-";

  let poidsGlobalAvecRacks = null;
  if (poidsGlobal != null) {
    poidsGlobalAvecRacks = +(poidsGlobal + poidsRacks).toFixed(1);
    poidsGlobalAvecRacksEl.textContent = poidsGlobalAvecRacks.toFixed(1) + " kg";
  } else {
    poidsGlobalAvecRacksEl.textContent = "-";
  }

  // Note transport navette / camion (seuil 350 kg)
  if (poidsGlobalAvecRacks != null) {
    if (poidsGlobalAvecRacks <= 350) {
      transportNoteEl.textContent =
        "Le poids total (avec estimation des racks/paniers) reste inférieur ou égal à 350 kg : " +
        "la navette reste possible, sous réserve des capacités de ton fourgon.";
    } else {
      transportNoteEl.textContent =
        "⚠️ Poids total estimé supérieur à 350 kg (avec racks/paniers). " +
        "Si tu prévoyais d'utiliser la navette, ce ne sera pas possible : " +
        "il faudra prévoir une livraison camion, à anticiper au minimum 3 jours ouvrés avant la date souhaitée.";
    }
  } else {
    transportNoteEl.textContent = "";
  }

  recapEl.textContent =
    `Configuration : ${params.L} m × ${params.H} m, largeur ${params.largeur} m, ` +
    `protection mur ${params.protection_mur}, grutage ${params.grutage}, ` +
    `stabilisation ${params.stabilisation}.`;

  blocResultat.style.display = "block";
}
</script>
</body>
</html>
