<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Configurateur échafaudage ALTRAD METRIX</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --primary: #c80000;
      --bg: #f5f5f5;
      --card: #ffffff;
      --border-radius: 12px;
      --text-main: #222;
      --text-muted: #666;
    }

    * { box-sizing: border-box; font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--text-main);
    }

    .app {
      max-width: 520px;
      margin: 0 auto;
      min-height: 100vh;
      padding: 16px;
    }

    h1 {
      text-align: center;
      font-size: 20px;
      margin-bottom: 16px;
      color: var(--primary);
    }

    .card {
      background: var(--card);
      border-radius: var(--border-radius);
      padding: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      margin-bottom: 16px;
    }

    label {
      display: block;
      font-size: 14px;
      margin-top: 10px;
      margin-bottom: 4px;
    }

    input, select {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 14px;
    }

    button {
      width: 100%;
      margin-top: 16px;
      padding: 12px;
      border-radius: 999px;
      border: none;
      background: var(--primary);
      color: white;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
    }

    button:disabled {
      opacity: 0.6;
      cursor: default;
    }

    .status {
      margin-top: 8px;
      font-size: 13px;
      color: var(--text-muted);
    }

    .status.error {
      color: #b71c1c;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      margin-top: 8px;
    }

    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid #eee;
      text-align: left;
    }

    th {
      background: #f0f0f0;
      font-weight: 600;
      font-size: 12px;
    }

    tfoot td {
      font-weight: 600;
      border-top: 2px solid #ccc;
    }

    .ref {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
    }

    .muted {
      color: var(--text-muted);
      font-size: 12px;
      margin-top: 4px;
    }
  </style>
</head>
<body>
<div class="app">
  <h1>Configurateur échafaudage</h1>

  <div class="card">
    <label>Longueur de façade L (m)</label>
    <input id="L" type="number" min="1" step="0.1" placeholder="ex : 5">

    <label>Hauteur H (m)</label>
    <input id="H" type="number" min="2" step="0.1" placeholder="ex : 6">

    <label>Largeur de l’échafaudage</label>
    <select id="largeur">
      <option value="0.70">0,70 m</option>
      <option value="1.00">1,00 m</option>
    </select>

    <label>Nombre de façades identiques (F)</label>
    <input id="F" type="number" min="1" step="1" value="1">

    <label>Protection côté mur ?</label>
    <select id="protection">
      <option value="OUI">OUI</option>
      <option value="NON">NON</option>
    </select>

    <label>Grutage prévu ?</label>
    <select id="grutage">
      <option value="OUI">OUI</option>
      <option value="NON">NON</option>
    </select>

    <label>Stabilisation</label>
    <select id="stabilisation">
      <option value="stabilisateurs">Stabilisateurs télescopiques</option>
      <option value="amarrage">Amarrage au mur</option>
    </select>

    <button id="btn-calcul">Lancer le calcul</button>
    <div id="status" class="status"></div>
  </div>

  <div class="card" id="bloc-resultat" style="display:none;">
    <div style="font-weight:600; margin-bottom:4px;">Liste de matériel ALTRAD METRIX</div>
    <div id="recap" class="muted"></div>
    <div style="overflow-x:auto;">
      <table id="tableau">
        <thead>
          <tr>
            <th>Référence</th>
            <th>Désignation</th>
            <th>Qté</th>
            <th>Poids unitaire (kg)</th>
            <th>Poids total (kg)</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
        <tfoot>
          <tr>
            <td colspan="4">Poids total échafaudage</td>
            <td id="poids-global"></td>
          </tr>
        </tfoot>
      </table>
    </div>
    <div class="muted">
      Le poids total ne tient pas compte des racks/paniers de transport.
    </div>
  </div>
</div>

<script>
const API_URL = "/api/calcul";

const btn = document.getElementById("btn-calcul");
const statusEl = document.getElementById("status");
const blocResultat = document.getElementById("bloc-resultat");
const tbody = document.getElementById("tbody");
const recapEl = document.getElementById("recap");
const poidsGlobalEl = document.getElementById("poids-global");

btn.addEventListener("click", async () => {
  const L = parseFloat(document.getElementById("L").value);
  const H = parseFloat(document.getElementById("H").value);
  const largeur = parseFloat(document.getElementById("largeur").value);
  const F = parseInt(document.getElementById("F").value, 10);
  const protection_mur = document.getElementById("protection").value;
  const grutage = document.getElementById("grutage").value;
  const stabilisation = document.getElementById("stabilisation").value;

  if (!L || !H || !F) {
    statusEl.textContent = "Merci de remplir au moins la longueur, la hauteur et le nombre de façades.";
    statusEl.className = "status error";
    return;
  }

  statusEl.textContent = "Calcul en cours…";
  statusEl.className = "status";
  btn.disabled = true;
  blocResultat.style.display = "none";

  try {
    const res = await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        L, H, largeur, F,
        protection_mur,
        grutage,
        stabilisation
      })
    });

    if (!res.ok) {
      throw new Error("Erreur HTTP " + res.status);
    }

    const data = await res.json();
    afficherResultats(data, { L, H, largeur, F, protection_mur, grutage, stabilisation });
    statusEl.textContent = "Calepinage terminé ✅";
    statusEl.className = "status";

  } catch (e) {
    console.error(e);
    statusEl.textContent = "Erreur lors de l’appel : " + e.message;
    statusEl.className = "status error";
  } finally {
    btn.disabled = false;
  }
});

function afficherResultats(data, params) {
  const items = data.items || [];
  const poidsGlobal = data.poids_total_global ?? null;

  tbody.innerHTML = "";

  if (items.length === 0) {
    tbody.innerHTML = "<tr><td colspan='5'>Aucun article calculé.</td></tr>";
  } else {
    for (const item of items) {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="ref">${item.reference}</td>
        <td>${item.designation || ""}</td>
        <td>${item.quantite}</td>
        <td>${item.poids_unitaire != null ? item.poids_unitaire.toFixed(1) : "-"}</td>
        <td>${item.poids_total != null ? item.poids_total.toFixed(1) : "-"}</td>
      `;
      tbody.appendChild(tr);
    }
  }

  if (poidsGlobal != null) {
    poidsGlobalEl.textContent = poidsGlobal.toFixed(1) + " kg";
  } else {
    poidsGlobalEl.textContent = "-";
  }

  recapEl.textContent =
    `Configuration : ${params.L} m × ${params.H} m, largeur ${params.largeur} m, ` +
    `${params.F} façade(s), protection mur ${params.protection_mur}, grutage ${params.grutage}, ` +
    `stabilisation ${params.stabilisation}.`;

  blocResultat.style.display = "block";
}
</script>
</body>
</html>
